generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model CustomerPayment {
  id               String           @id @default(cuid())
  paymentId        String           @unique
  customerId       String           @unique
  email            String?          @unique
  subscriptionType SubscriptionType @default(FREE)
  createdAt        DateTime?        @default(now())
  deletedAt        DateTime?
  updatedAt        DateTime?        @updatedAt

  customer User @relation(fields: [customerId], references: [id])

  @@map("customerPayments")
}

model Domain {
  id        String    @id @default(cuid())
  branchId  String
  addedById String
  name      String
  subdomain String?
  verified  Boolean?  @default(true)
  value     String?
  createdAt DateTime? @default(now())
  deletedAt DateTime?
  updatedAt DateTime? @updatedAt

  addedBy User   @relation(fields: [addedById], references: [id])
  branch  Branch @relation(fields: [branchId], references: [id])

  @@map("domains")
}

model Member {
  id        String    @id @default(cuid())
  branchId  String
  email     String
  inviter   String
  invitedAt DateTime? @default(now())
  joinedAt  DateTime?
  deletedAt DateTime?
  updatedAt DateTime? @updatedAt

  status    InvitationStatus @default(PENDING)
  teamRole  TeamRole         @default(MEMBER)
  member    User?            @relation(fields: [email], references: [email], name: "membership")
  invitedBy User?            @relation(fields: [inviter], references: [email], name: "inviter")
  branch    Branch           @relation(fields: [branchId], references: [id])

  @@unique([branchId, email])
  @@map("members")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  userCode      String    @unique @default(cuid())
  name          String?
  email         String?   @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime? @default(now())
  deletedAt     DateTime?
  updatedAt     DateTime? @updatedAt

  accounts        Account[]
  sessions        Session[]
  membership      Member[]         @relation("membership")
  invitedMembers  Member[]         @relation("inviter")
  createdBranches Branch[]
  customerPayment CustomerPayment?
  domains         Domain[]

  @@unique([userCode, email])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationTokens")
}

model Branch {
  id           String       @id @default(cuid())
  branchCode   String       @unique @default(cuid())
  inviteCode   String       @unique @default(cuid())
  creatorId    String
  name         String
  slug         String
  idBranch     Int?         @unique // Identificador numérico único da academia
  internalName String?
  cnpj         String?
  address      String?
  neighborhood String?
  number       String?
  complement   String?
  city         String?
  state        String?
  stateShort   String?
  zipCode      String?
  telephone    String?
  whatsapp     String?
  email        String?
  website      String?
  latitude     Float?
  longitude    Float?
  openingDate  DateTime?
  logoUrl      String?
  status       BranchStatus @default(ACTIVE)
  createdAt    DateTime?    @default(now())
  deletedAt    DateTime?
  updatedAt    DateTime?    @updatedAt

  // Campos de assinatura/pagamento
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  subscriptionPlan   SubscriptionPlan   @default(BASIC)
  stripeCustomerId   String?            @unique
  stripeSubscriptionId String?          @unique
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  lastPaymentAt      DateTime?

  creator        User                   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  members        Member[]
  domains        Domain[]
  paymentHistory BranchPaymentHistory[]

  @@unique([branchCode, inviteCode])
  @@index([status])
  @@index([subscriptionStatus])
  @@map("branches")
}

model BranchPaymentHistory {
  id              String   @id @default(cuid())
  branchId        String
  stripePaymentId String?
  amount          Int      // em centavos
  currency        String   @default("BRL")
  status          String   // succeeded, failed, pending
  description     String?
  createdAt       DateTime @default(now())

  branch Branch @relation(fields: [branchId], references: [id])

  @@map("branchPaymentHistory")
}

enum InvitationStatus {
  ACCEPTED
  PENDING
  DECLINED
}

enum SubscriptionType {
  FREE
  STANDARD
  PREMIUM
}

enum TeamRole {
  MEMBER
  OWNER
}

enum UserRole {
  USER
  ADMIN
}

enum BranchStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  TRIAL       // Período de teste
  ACTIVE      // Assinatura ativa
  PAST_DUE    // Pagamento atrasado (ainda com acesso)
  SUSPENDED   // Suspenso por falta de pagamento
  CANCELLED   // Cancelado pela academia
}

enum SubscriptionPlan {
  BASIC       // Plano básico
  PRO         // Plano profissional
  ENTERPRISE  // Plano empresarial
}
